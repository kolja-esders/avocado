<html>
    <head>
        <meta charset="utf-8" />
        
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0"/>
        <script src="cordova.js"></script>      
		<script>   
            myARContent = null;
            itemsDict = {};
            function didGetResults(results) {
                if(results.length > 0) {
                    var item = results[0].item;
                    if (item.isAR) {
                        if (itemsDict[item.uuid] === undefined) {
                            myARItem = item;
                            itemsDict[item.uuid] = myARItem;

                            CraftARContent.createImageContentWithPath("ar_content.png", function(contentImage){
                                myARContent = contentImage;
                                 contentImage.wrapMode = CraftARContent.CRAFTAR_TRACKING_WRAP_ASPECT_FIT;
                                contentImage.attachTo(item);
                                CraftARTracking.addItem(item, function(){
                                    CraftARTracking.startTracking();
                                    toggleTabItem("#loadingGif", "hide");
                                    toggleTabItem("#switchContent", "show");
                                },function(err) {
                                    alert("Error adding AR item: " + err.errorMessage);
                                    CraftARSDK.startFinder();
                                });
                            });
                        }
                    } else {
                        CraftARSDK.startFinder();
                    }

                }
            }

            function onError(error) {
                // Search errors are reported here, we usually don't want to stop the finder mode
            }

            function didStartCapture() {
               CraftARSDK.searchController = CraftARCloudRecognition.searchController;
               CraftARCloudRecognition.onSearchResults(didGetResults);
               CraftARCloudRecognition.onSearchError(onError);
               CraftARCloudRecognition.setCollectionWithToken("augmentedreality", function() {
                    CraftARSDK.startFinder();
               }, function(err) {
                    alert("Error setting token: " + err.errorMessage);
               });                 
            }

            function didGetTouchEvent(touch) {
                var event = touch.event;
                var content = touch.content;
                switch (event) {
                    case CraftARTouch.CRAFTAR_CONTENT_TOUCH_IN:
                        console.log("Touch in: " + content.uuid);
                        break;
                    case CraftARTouch.CRAFTAR_CONTENT_TOUCH_OUT:
                        console.log("Touch out: " + content.uuid);
                        break;
                    case CraftARTouch.CRAFTAR_CONTENT_TOUCH_UP:
                        console.log("Touch up: " + content.uuid);
                        break;
                    case CraftARTouch.CRAFTAR_CONTENT_TOUCH_DOWN:
                        console.log("Touch down: " + content.uuid);
                        break;
                    default:
                        break;
                }
            }

            function didStartTrackingItem(item) {
                console.log("Start tracking Item: " + item.uuid);
            }


            function didStopTrackingItem(item) {
                console.log("Stop tracking item: " + item.uuid);
            }


            function didTrackingTimeout() {
                alert("Tracking timeout");
            }

            function startCraftAR() 
            {
               CraftARTouch.onTouchEvent(didGetTouchEvent);

               CraftARTracking.onStartTracking(didStartTrackingItem);  
               CraftARTracking.onStopTracking(didStopTrackingItem);
               CraftARTracking.onTrackingTimeOut(didTrackingTimeout);

               CraftARSDK.onStartCapture(didStartCapture); 
               CraftARSDK.startCapture();
            }

            function changeContent() {
                var myARItem = null;
                for (var key in itemsDict) {
                    myARItem = itemsDict[key];
                    break;
                }
                myARContent.detachFrom(myARItem);
                
                CraftARContent.createImageContentWithPath("ar_content_2.jpg", function(newImageContent){
                    newImageContent.wrapMode = CraftARContent.CRAFTAR_TRACKING_WRAP_ASPECT_FIT;
                    newImageContent.attachTo(myARItem);
                    myARContent = newImageContent;
                });
            }

            document.addEventListener("deviceready", function() {
                startCraftAR();
                toggleTabItem("#loadingGif", "show");
                toggleTabItem("#switchContent", "hide");
            }, false);


            function toggleTabItem(name, action) {
                if (action === "hide") {
                    $(name).css("visibility", "hidden");
                    $(name).removeClass("tab-item");
                    $(name).css("width", "0px");
                } else {
                    $(name).css("visibility", "visible");
                    $(name).addClass("tab-item");
                    $(name).css("width", "auto");
                }
            }

            
            function goBack() {
                CraftARSDK.stopFinder();
                CraftARTracking.stopTracking();
                CraftARSDK.closeView();
            }

		</script>
		
    </head>
    <body>
       <h1 id="progress"></h1>
        <div class="bar bar-header bar-light">
            <h5 class="title" id="headerTitle">AR Programmatically</h5>
            <ion-nav-buttons side="left">
                <button class="button button-clear" onclick="goBack()" >Back</button>
            </ion-nav-buttons>
        </div>

        <div class="tabs tabs-icon-only" >
            <a class="tab-item" id="switchContent" style="visibility:hidden;width:0px;text-align:center;" onclick="changeContent()">
                Switch content
            </a>
            <div id="loadingGif" style="visibility:visible;width:0px;">
                <img src="img/spinner.gif" style="height:80%;"/>
            </div>
        </div>

        <div id="popUpDiv" style="color:white" >
            <div id="popUpMainDiv">
                <img src="img/closeButton.png" id="closeButton" onclick=" $('#popUpDiv').fadeOut('slow', function () {
                            popUpActive = false;
                        });" alt="" style="max-width: 80%; max-height: 80%"/>
                <div id="responseDiv">
                    <div id="imageResponse">
                        <img src="#" id="image_src" alt=""/>
                    </div>
                    <div id="textResponse">
                        <h1 id="nameResponse"></h1>
                        <h3 id="idResponse"></h3>
                    </div>

                </div>
            </div>
        </div>
    </body>
</html>
